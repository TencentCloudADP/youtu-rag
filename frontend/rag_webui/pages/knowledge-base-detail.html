<!-- Knowledge Base Detail Page -->
<div class="page-header card" style="margin-bottom: 6px;">
  <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
    <button class="btn btn-secondary" onclick="router.navigate('/knowledge')" style="padding: 8px 16px;">
      <span data-i18n="back">← 返回</span>
    </button>
    <div class="header-left" style="flex: 1;">
      <h1 class="header-title" id="kb-detail-name">知识库详情</h1>
      <p id="kb-detail-description" style="margin: 8px 0 0 0; color: var(--gray-7); font-size: 14px;"></p>
    </div>
    <button class="btn btn-secondary" onclick="showConfigModal()" style="padding: 8px 16px;">
      <span data-i18n="view_config">⚙️ 查看配置</span>
    </button>
  </div>
</div>

<!-- Data Source Tabs -->
<div class="card" style="margin-bottom: 24px;">
  <div class="config-tabs" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 0;">
      <button class="config-tab active" onclick="switchDataSourceTab('file', event)" style="font-size: 16px;"><span data-i18n="file_association">文件关联</span>
      </button>
      <button class="config-tab" onclick="switchDataSourceTab('database', event)" style="font-size: 16px;"><span data-i18n="database_association">关系数据库关联</span>
      </button>
      <button class="config-tab" onclick="switchDataSourceTab('qa', event)" style="font-size: 16px;"><span data-i18n="qa_association">示例关联与学习</span>
      </button>
    </div>
    <div style="display: flex; gap: 12px;">
      <button class="btn btn-secondary" onclick="saveKnowledgeBaseConfiguration()" style="padding: 8px 16px;">
        <img src="assets/images/save.svg" alt="Save" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
        <span data-i18n="save_association">保存关联</span>
      </button>
      <button class="btn btn-secondary" onclick="buildKnowledgeBaseFromDetail()" style="padding: 8px 16px;">
        <img src="assets/images/build.svg" alt="build" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
        <span data-i18n="build_knowledge_base">构建知识库</span>
      </button>
    </div>
  </div>

  <!-- File Selection Tab -->
  <div id="datasource-tab-file" class="config-tab-content active">
    <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="showFileSelectionModal()">
          <span data-i18n="select_files">选择文件</span>
        </button>
        <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
          <div class="search-input" style="flex: 1; max-width: 300px; margin-right: auto;">
            <input type="text" id="selected-files-search" class="input" placeholder="搜索已选文件..." data-i18n-placeholder="search_selected_files" oninput="handleSelectedFilesSearch(this.value)">
            <i class="icon icon-search"></i>
          </div>
          <button id="selected-files-select-btn" class="btn btn-secondary" onclick="toggleSelectedFilesSelectMode()">
            <img src="assets/images/select.svg" alt="Select" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
            <span data-i18n="batch_select">批量选择</span>
          </button>
          <button id="selected-files-batch-delete-btn" class="btn" style="display: none; background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;" onclick="batchDeleteSelectedFiles()">
            <img src="assets/images/delete.svg" alt="Delete" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: invert(23%) sepia(89%) saturate(3815%) hue-rotate(346deg) brightness(88%) contrast(92%);">
            <span id="selected-files-batch-delete-text" data-i18n="delete_selected" data-i18n-options='{"count": 0}'>删除选中(0)</span>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div id="selected-files-header" class="files-list-header" style="display: none;">
        <div style="flex: 1; min-width: 0;" data-i18n="file_name">文件名</div>
        <div style="width: 120px; text-align: center;" data-i18n="processing_status">处理状态</div>
        <div style="width: 100px; text-align: center;" data-i18n="actions">操作</div>
      </div>
      <div id="selected-files-container">
        <!-- 已选文件列表 -->
      </div>
      <div id="selected-files-pagination" class="pagination-controls" style="display: none;">
        <!-- 分页控制 -->
      </div>
    </div>
  </div>

  <!-- Database Configuration Tab -->
  <div id="datasource-tab-database" class="config-tab-content">
    <div class="card-body">
      <div class="form-group">
        <label class="form-label" data-i18n="database_type">数据库类型</label>
        <select id="db-type" class="input" onchange="handleDBTypeChange()">
          <option value="sqlite" selected>SQLite</option>
          <option value="mysql">MySQL</option>
        </select>
      </div>

      <div id="mysql-fields" style="display: none;">
        <div class="form-group">
          <label class="form-label" data-i18n="host_address">主机地址</label>
          <input type="text" id="db-host" class="input" placeholder="localhost" value="gz-cdb-4drndvif.sql.tencentcdb.com">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="port">端口</label>
          <input type="number" id="db-port" class="input" placeholder="3306" value="23456">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="database_name">数据库名</label>
          <input type="text" id="db-database" class="input" placeholder="database_name" value="wj_agenticrag_text2sql_multi_mini_2512">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="username">用户名</label>
          <input type="text" id="db-username" class="input" placeholder="username">
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="password">密码</label>
          <input type="password" id="db-password" class="input" placeholder="password">
        </div>
      </div>

      <div id="sqlite-fields">
        <div class="form-group">
          <label class="form-label" data-i18n="sqlite_file_path">SQLite文件路径</label>
          <input type="text" id="db-file-path" class="input" placeholder="/path/to/database.sqlite">
          <p style="font-size: 12px; color: var(--gray-7); margin-top: 4px;" data-i18n="sqlite_file_path_hint">
            请输入SQLite文件的完整路径
          </p>
        </div>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
        <button class="btn btn-primary" onclick="testDatabaseConnection()">
          <span data-i18n="test_connection_load_tables">测试连接并加载表</span>
        </button>
        <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
          <div class="search-input" style="flex: 1; max-width: 300px; margin-right: auto;">
            <input type="text" id="db-tables-search" class="input" placeholder="搜索表名..." data-i18n-placeholder="search_table_name" oninput="handleDBTablesSearch(this.value)">
            <i class="icon icon-search"></i>
          </div>
          <button id="db-tables-select-btn" class="btn btn-secondary" onclick="toggleDBTablesSelectMode()">
            <img src="assets/images/select.svg" alt="Select" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
            <span data-i18n="batch_select">批量选择</span>
          </button>
          <button id="db-tables-batch-delete-btn" class="btn" style="display: none; background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;" onclick="batchDeleteDBTables()">
            <img src="assets/images/delete.svg" alt="Delete" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: invert(23%) sepia(89%) saturate(3815%) hue-rotate(346deg) brightness(88%) contrast(92%);">
            <span id="db-tables-batch-delete-text" data-i18n="delete_selected" data-i18n-options='{"count": 0}'>删除选中(0)</span>
          </button>
        </div>
      </div>

      <div id="db-test-status" style="margin-bottom: 16px; display: none;"></div>

      <div id="table-selection-area" style="display: none; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="select-all-tables" onchange="toggleAllTables(this.checked)">
            <span data-i18n="select_tables_to_include">选择要包含的表</span>
          </label>
          <div id="table-list" style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px; max-height: 200px; overflow-y: auto; padding: 8px; background: var(--gray-2); border-radius: var(--radius-md);">
          </div>
        </div>

        <button class="btn btn-success" onclick="addDatabaseConnection()">
          <span data-i18n="add_selected_tables">➕ 添加选中的表到知识库</span>
        </button>
      </div>

      <div style="overflow-x: auto;">
        <div id="db-tables-header" class="files-list-header" style="display: none; min-width: 620px;">
          <div style="flex: 1; min-width: 0;" data-i18n="table_name">表名</div>
          <div style="width: 100px; text-align: center;" data-i18n="database_type_col">数据库类型</div>
          <div style="width: 200px; text-align: center;" data-i18n="database_name_col">数据库名</div>
          <div style="width: 120px; text-align: center;" data-i18n="processing_status">处理状态</div>
          <div style="width: 100px; text-align: center;" data-i18n="actions">操作</div>
        </div>
        <div id="db-connections-list" style="min-width: 620px;"></div>
      </div>
      <div id="db-connections-pagination" class="pagination-controls" style="display: none;"></div>
    </div>
  </div>

  <!-- Q&A File Selection Tab -->
  <div id="datasource-tab-qa" class="config-tab-content">
    <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="showQAFileSelectionModal()">
          <span data-i18n="select_qa_files">选择Q&A文件</span>
        </button>
        <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
          <div class="search-input" style="flex: 1; max-width: 300px; margin-right: auto;">
            <input type="text" id="selected-qa-files-search" class="input" placeholder="搜索已选Q&A文件..." data-i18n-placeholder="search_selected_qa_files" oninput="handleSelectedQAFilesSearch(this.value)">
            <i class="icon icon-search"></i>
          </div>
          <button id="selected-qa-files-select-btn" class="btn btn-secondary" onclick="toggleSelectedQAFilesSelectMode()">
            <img src="assets/images/select.svg" alt="Select" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
            <span data-i18n="batch_select">批量选择</span>
          </button>
          <button id="selected-qa-files-batch-delete-btn" class="btn" style="display: none; background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;" onclick="batchDeleteSelectedQAFiles()">
            <img src="assets/images/delete.svg" alt="Delete" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: invert(23%) sepia(89%) saturate(3815%) hue-rotate(346deg) brightness(88%) contrast(92%);">
            <span id="selected-qa-files-batch-delete-text" data-i18n="delete_selected" data-i18n-options='{"count": 0}'>删除选中(0)</span>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <img src="assets/images/speaker_loud.svg" alt="speaker_loud" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
         <span data-i18n="excel_format_requirement">Excel格式要求: Sheet名称"示例"，列头：question, answer, howtofind</span>
      </div>
      <div id="selected-qa-files-header" class="files-list-header" style="display: none;">
        <div style="flex: 1; min-width: 0;" data-i18n="file_name">文件名</div>
        <div style="width: 120px; text-align: center;" data-i18n="processing_status">处理状态</div>
        <div style="width: 100px; text-align: center;" data-i18n="actions">操作</div>
      </div>
      <div id="selected-qa-files-container"></div>
      <div id="selected-qa-files-pagination" class="pagination-controls" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- File Selection Modal -->
<div id="file-selection-modal" class="modal-overlay" style="display: none;"
     onclick="if(event.target === this) hideModal('file-selection-modal')">
  <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title" data-i18n="select_files_modal_title">选择文件</h2>
      <span class="modal-close" onclick="hideModal('file-selection-modal')">&times;</span>
    </div>
    <div class="modal-body">
      <div class="search-input" style="margin-bottom: 16px;">
        <input type="text" id="file-modal-search" class="input"
               placeholder="搜索文件..."
               data-i18n-placeholder="search_files"
               oninput="filterFilesInModal(this.value)">
        <i class="icon icon-search"></i>
      </div>
      <!-- Batch selection buttons -->
      <div style="margin-bottom: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <button class="btn btn-success" onclick="selectAllFilesInModal()" style="font-size: 13px; padding: 6px 12px;">
          <span data-i18n="select_all">✓ 全选</span>
        </button>
        <button class="btn btn-success" onclick="selectCurrentPageFilesInModal()" style="font-size: 13px; padding: 6px 12px;">
          <span data-i18n="select_current_page">✓ 当前页</span>
        </button>
        <button class="btn btn-secondary" onclick="deselectAllFilesInModal()" style="font-size: 13px; padding: 6px 12px;">
          <span data-i18n="deselect_all">✗ 取消</span>
        </button>
        <span id="file-selection-count" style="margin-left: auto; font-size: 13px; color: var(--gray-7); font-weight: 500;"></span>
      </div>
      <div id="file-modal-list" style="max-height: 400px; overflow-y: auto;">
        <!-- 文件复选框列表 -->
      </div>
      <div id="file-modal-pagination" class="pagination-controls" style="margin-top: 12px; display: none;">
        <!-- 分页控制 -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideModal('file-selection-modal')" data-i18n="cancel">取消</button>
      <button class="btn btn-primary" onclick="confirmFileSelection()">
        <span data-i18n="confirm">确认</span>
      </button>
    </div>
  </div>
</div>

<!-- Q&A File Selection Modal -->
<div id="qa-file-selection-modal" class="modal-overlay" style="display: none;"
     onclick="if(event.target === this) hideModal('qa-file-selection-modal')">
  <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" data-i18n="select_qa_excel_files">选择Q&A Excel文件</h2>
      <span class="modal-close" onclick="hideModal('qa-file-selection-modal')">&times;</span>
    </div>
    <div class="modal-body">
      <div class="alert alert-info" data-i18n="only_show_excel_files">
        ℹ️ 只显示Excel文件（.xls, .xlsx）
      </div>
      <div id="qa-file-modal-list" style="max-height: 400px; overflow-y: auto;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideModal('qa-file-selection-modal')" data-i18n="cancel">取消</button>
      <button class="btn btn-primary" onclick="confirmQAFileSelection()" data-i18n="confirm_selection">确认选择</button>
    </div>
  </div>
</div>


<!-- Configuration Modal (Right Side) -->
<div id="config-modal" class="modal-right-overlay" style="display: none;" onclick="if(event.target === this) hideConfigModal()">
  <div class="modal-right" onclick="event.stopPropagation()">
    <div class="modal-right-header">
      <h2 class="modal-right-title" data-i18n="config_view">⚙️ 配置查看</h2>
      <button class="modal-right-close" onclick="hideConfigModal()">&times;</button>
    </div>
    <div class="modal-right-body">
      <!-- Tabs -->
      <div class="config-tabs">
        <button class="config-tab active" onclick="switchConfigTab('kb', event)">
          <span data-i18n="kb_config">📦 知识库配置</span>
        </button>
        <button class="config-tab" onclick="switchConfigTab('yaml', event)">
          <span data-i18n="default_yaml_config">📄 默认YAML配置</span>
        </button>
      </div>

      <!-- Knowledge Base Config Tab -->
      <div id="config-tab-kb" class="config-tab-content active">
        <div id="config-display-kb" class="config-display">
          <!-- KB configuration content -->
        </div>
      </div>

      <!-- YAML Config Tab -->
      <div id="config-tab-yaml" class="config-tab-content">
        <div id="config-display-yaml" class="config-display">
          <!-- YAML configuration content -->
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Build Progress Modal -->
<div id="build-progress-modal" class="modal-overlay" style="display: none;">
  <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title" data-i18n="build_kb_modal_title">构建知识库</h2>
    </div>
    <div class="modal-body">
      <p id="build-status-text" data-i18n="building_kb_please_wait">正在构建知识库，请稍候...</p>
      <div class="progress" style="margin-top: 16px;">
        <div class="progress-bar" id="build-progress-bar" style="width: 0%;"></div>
      </div>
      <p id="build-progress-text" style="margin-top: 8px; font-size: 14px; color: var(--gray-7);">0%</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideModal('build-progress-modal')" data-i18n="close">关闭</button>
    </div>
  </div>
</div>
